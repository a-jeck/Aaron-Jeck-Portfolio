<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/portfolio/calendar/calendar-stylesheet.css">
</head>

<body>

    <!-- Event Modal for creating a new event -->
    <div id="createEventModal">
        New Event <br>

        <!-- Time and Title inputs -->
        <label for="newEventTitle">Title:</label><input type="text" id="newEventTitle"> <br>
        <label for="newEventTime">Time:</label><input type="time" id="newEventTime"> <br>

        <!-- Event color selection -->
        <input type="hidden" id="createColor" value="">
        <p class="colorCreate" id="createColor0"> </p>
        <p class="colorCreate" id="createColor1"> </p>
        <p class="colorCreate" id="createColor2"> </p>
        <p class="colorCreate" id="createColor3"> </p>
        <p class="colorCreate" id="createColor4"> </p>
        <p class="colorCreate" id="createColor5"> </p> <br>

        <!-- Create and Cancel event creation buttons -->
        <button type="button" id="createEventBtn">Create</button>
        <button type="button" id="cancelEventBtn">Cancel</button>
    </div>


    <!-- Div to contain birthday confetti -->
    <div id="confetti"></div>


    <!-- Event Modal for viewing en event -->
    <div id="viewEventModal">

        <!-- Div for the title of the view modal -->
        <div id="viewHeaderTitle"></div>

        <!-- Div for the close and edit buttons of the view modal -->
        <div id="viewHeaderClose">
            <button id="editViewBtn">Edit</button>
            <button id="closeViewBtn">Close</button>
        </div>

        <!-- Body of the view modal -->
        <div id="viewBody"></div>


        <!-- Div for editing an event -->
        <div id="viewEdit">

            <!-- Inputs for the new text and time -->
            <input type="text" id="editedTitle"> <br>
            <input type="time" id="editedTime" value=""> <br>

            <!-- Inputs for selecting a new event color -->
            <input type="hidden" id="editedColor" value="">
            <p class="colorEdit" id="editColor0"> </p>
            <p class="colorEdit" id="editColor1"> </p>
            <p class="colorEdit" id="editColor2"> </p>
            <p class="colorEdit" id="editColor3"> </p>
            <p class="colorEdit" id="editColor4"> </p>
            <p class="colorEdit" id="editColor5"> </p> <br>

            <!-- Stores the ID of the event, for editing and deletion -->
            <input type="hidden" id="editID">

            <!-- Buttons for applying the edits or deleting the event -->
            <button id="applyEdit">Apply Edit</button>
            <button id="deleteEvent">Delete</button>
        </div>
    </div>


    <!-- Header - login/logout and change month -->
    <div id="header">

        <!-- Buttons to go forward/backwards a month -->
        <p id="monthButtons">
            <button type="button" id="back_month">&lt;</button>
            <button type="button" id="next_month">&gt;</button>
        </p>

        <!-- Buttons to login or logout -->
        <p id="userButtons">
            <button type="button" id="login">Login</button>
            <button type="button" id="logout">Logout</button>
        </p>
    </div>


    <!-- Login Page - contains the inputs for logging in and signing up -->
    <div id="login_page" class="body">

        <!-- Take user back to the calendar  -->
        <button type="button" id="home_btn">Home</button>

        <!-- All login fields: Login error, password input, and email input section. Also contains the CSRF token for the session. -->
        <p id="login_error"></p>
        <input type="hidden" id="token" value="">
        <label for="email_input_login">Email:</label><input type="text" id="email_input_login"> <br>
        <label for="password_input_login">Password:</label><input type="password" id="password_input_login"> <br>
        <br>
        <input type="submit" id="login_button" value="Login"> <br><br>


        <!-- ALl signup fields: signup error and password/name/email input -->
        <p id="signup_error"></p>
        <label for="email_input_signup">Email:</label><input type="text" id="email_input_signup"> <br>
        <label for="password_input_signup">Password:</label><input type="password" id="password_input_signup"> <br>
        <label for="password_input_signup_confirm">Confirm Password:</label><input type="password"
            id="password_input_signup_confirm"> <br>
        <label for="firstname_input">First name:</label><input type="text" id="firstname_input"> <br>
        <label for="lastname_signup">Last name:</label><input type="text" id="lastname_signup"> <br>
        <input type="submit" id="signup_button" value="Signup">
    </div>


    <!-- div for calendar - filled in by JS and reset each time the month is changed -->
    <div id="calendar" class="body"></div>


    <script>
        ////////////////// Basic variables //////////////////
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const days_in_month = ['31', '28', '31', '30', '31', '30', '31', '31', '30', '31', '30', '31'];
        const weekdays_all = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const colors = ['#BCE29E', '#BCCEF8', '#00bfff', '#EEE9DA', '#FF8787', '#F8C4B4'];
        // const create = false; // ME! is this used anywhere?
        let today = new Date();
        let date = {
            month: today.getMonth(),
            year: today.getFullYear()
        }


        ////////////////// Basic functions //////////////////
        /// initial functions to load for the first time and populate the calendar div /// 
        close_login();
        loadBlankCalendar();


        ////////////////// Change month //////////////////

        // Moves the calendar back 1 month
        const back_month = document.getElementById('back_month');
        back_month.addEventListener('click', function () {

            // Updates the date
            date = month_update(-1);

            // Loads in new month and all its events 
            newMonth();
        }, false);

        const next_month = document.getElementById('next_month');
        next_month.addEventListener('click', function () {

            // Updates the date
            date = month_update(1);

            // Loads in new month and all its events 
            newMonth();
        }, false);


        // Loads in new month and all its events 
        function newMonth() {
            // Clears out all the old days and events (resets calendar div)
            resetCalendar();

            // Loads month and weekday labels
            calendarSetup();

            // Loads proper number of days with their date
            dayInitialize();

            // Adds most user experience, inlcuding events and listeners for modals
            addUserFn();

            //  Add the ability to create events
            addCreateEvents();

            // Closes the create/view modals, as necessary
            closeCreateEvent();
            closeViewModal();
            checkUser();

        }

        //Updates the date (month)
        function month_update(month_change) {
            // Update month
            date.month = date.month + month_change;

            // Update year and month if necessary
            if (date.month > 11) {
                date.year = date.year + 1;
                date.month = 0;
            } else if (date.month < 0) {
                date.year = date.year - 1;
                date.month = 11;
            }


            // Return new date
            return date;
        }


        ////// Resets the calendar, removes every element //////
        function resetCalendar() {
            let calendar = document.getElementById('calendar');
            while (calendar.firstChild) {
                calendar.removeChild(calendar.firstChild);
            }
        }


        ////// Handles closing the event creation modal //////
        document.getElementById("cancelEventBtn").addEventListener('click', closeCreateEvent, false)
        function closeCreateEvent() {

            // Hides the modal
            document.getElementById('createEventModal').style.display = 'none';

            // Ensures the "new event" block is gone everywhere
            let allNewEvents = document.querySelectorAll('.newEvent');
            for (let i = 0; i < allNewEvents.length; i++) {
                allNewEvents[i].innerHTML = '';
                allNewEvents[i].style.display = 'none';
            }

            // resets title and time fields inside Create Event Modal to be blank
            let title = document.getElementById('newEventTitle');
            let time = document.getElementById('newEventTime');
            title.value = "";
            time.value = "";
        }


        ////// Handles closing the event viewer modal //////
        function closeViewModal() {
            let viewEventModal = document.getElementById('viewEventModal');
            viewEventModal.style.display = 'none';


        }




        ////////////////// Login and Logout Related Functions //////////////////

        ////// Sign Out Listener //////
        document.getElementById("logout").addEventListener('click', function () {
            fetch("signout.php")
                .then(signout => signout.json())
                .then(signout => {
                    const signoutJSON = JSON.parse(JSON.stringify(signout));
                    if (signoutJSON.status) {
                        checkUser();
                        reload();
                    } else {
                        alert('Error: ' + signoutJSON.error);
                    }
                })
                .catch(err => console.error(err));
        });

        ////// Open the login page and close the calendar //////
        document.getElementById("login").addEventListener('click', open_login, false);
        function open_login() {

            // Hide the calendar
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'none';

            // Hide month header
            const header = document.getElementById('header');
            header.style.display = 'none';

            // Unhide login page div
            const login = document.getElementById('login_page');
            login_page.style.display = 'block';
        }

        ////// Close the login page and open the calendar //////
        document.getElementById("home_btn").addEventListener('click', close_login, false);
        function close_login() {

            // Show calendar div and header, hide login
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'block';
            const header = document.getElementById('header');
            header.style.display = 'block';
            const login = document.getElementById('login_page');
            login_page.style.display = 'none';

            // resets all the login/signup fields
            document.getElementById('email_input_login').value = '';
            document.getElementById('password_input_login').value = '';
            document.getElementById('email_input_signup').value = '';
            document.getElementById('password_input_signup').value = '';
            document.getElementById('password_input_signup_confirm').value = '';
            document.getElementById('firstname_input').value = '';
            document.getElementById('lastname_signup').value = '';
            checkUser(); // toggles login/logout header button
            reload();
        }

        ////// Checks if User is logged in and sets the login/logout button accordingly //////
        function checkUser() {
            fetch("userCheck.php")
                .then(user_check => user_check.json())
                .then(user_check => {
                    const user_check_json = JSON.parse(JSON.stringify(user_check));

                    // Check for any erorr codes
                    if (user_check_json.status) {
                        // If a user is logged in:
                        if (user_check_json.loggedIn) {

                            // Show logout, hide login
                            document.getElementById('login').style.display = 'none';
                            document.getElementById('logout').style.display = 'inline-block';
                        } else {

                            // Show login, hide logout
                            document.getElementById('login').style.display = 'inline-block';
                            document.getElementById('logout').style.display = 'none';
                        }
                    } else {
                        alert(user_check_json.error);
                    }
                })
                .catch(err => console.error(err));
        }

        ////// Handles the signup process //////
        document.getElementById("signup_button").addEventListener('click', function () {
            // Retrieve each piece of the signup process
            const email = document.getElementById('email_input_signup').value;
            const pwd = document.getElementById('password_input_signup').value;
            const pwd_conf = document.getElementById('password_input_signup_confirm').value;
            const first_name = document.getElementById('firstname_input').value;
            const last_name = document.getElementById('lastname_signup').value;

            // Store it in a data object
            const signup_data = {
                'email': email,
                'pwd': pwd,
                'pwd_conf': pwd_conf,
                'first_name': first_name,
                'last_name': last_name
            }

            // Determine if any piece of data was left empty
            let isEmpty = false;
            for (const entry in signup_data) {
                if ((signup_data[entry]) == '') {
                    isEmpty = true;
                }
            }
            if (!isEmpty) {
                if (pwd == pwd_conf) {
                    // If pwds match, reset the error field and send to PHP for processing
                    document.getElementById('signup_error').innerText = '';

                    // Attempt signup
                    fetch("signup.php", {
                        method: 'POST',
                        body: JSON.stringify(signup_data),
                        headers: { 'content-type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(signup_data => {
                            const data_json = JSON.parse(JSON.stringify(signup_data));
                            if (data_json.status) {
                                if (data_json.exists) {
                                    // Alert user if email is already in use
                                    document.getElementById('signup_error').innerText = 'Email is already in use!';
                                } else {
                                    // Signup success; alert user they may now signup
                                    document.getElementById('signup_error').innerText = 'You may now login!';
                                }
                            } else {
                                alert(data_json.error);
                            }

                        })
                        .catch(err => console.error(err));
                } else {
                    // If passwords do not match, alert user
                    document.getElementById('signup_error').innerText = 'Passwords do not match!';
                }
            } else {

                // If something was left empty, alert user
                document.getElementById('signup_error').innerText = 'Please fill in all fields.';
            }
        });




        ////// Handles the login process //////
        document.getElementById("login_button").addEventListener('click', function () {

            // Retrieve each piece of the signup process
            const email = document.getElementById('email_input_login').value;
            const pwd = document.getElementById('password_input_login').value;

            // Store it in a data object
            const login_data = {
                'email': email,
                'pwd': pwd,
            }

            // Determine if any piece of data was left empty
            let isEmpty = false;
            for (const entry in login_data) {
                if ((login_data[entry]) == '') {
                    isEmpty = true;
                    break;
                }
            }

            if (!isEmpty) {
                document.getElementById('login_error').innerText = '';

                fetch("login.php", {
                    method: 'POST',
                    body: JSON.stringify(login_data),
                    headers: { 'content-type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(login_data => {
                        const data_json = JSON.parse(JSON.stringify(login_data));
                        if (data_json.success) {
                            // SUCCESSFULLY LOGGED IN
                            document.getElementById('token').value = data_json.token;
                            document.getElementById('signup_error').innerText = '';
                            close_login();
                        } else {
                            // LOGIN FAILED
                        }
                    })
                    .catch(err => console.error(err));

            } else {

                // If something was left empty, alert user
                document.getElementById('login_error').innerText = 'Please fill in all fields.';
            }

        });



        function loadBlankCalendar() {

            // Loads month and weekdays
            calendarSetup();

            // Loads the correct number of days labelled with their number
            dayInitialize();

            //  Add the ability to create events
            addCreateEvents();

            // Add view modal buttons (close, edit, etc.)
            viewButtons();
        }


        function calendarSetup() {
            // Display current month
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '<h1>' + months[date.month] + " " + date.year + ' </h1>';

            // Display the weekdays above the calendar
            const weekdays = document.createElement('div');
            weekdays.setAttribute("class", "weekdays");
            calendar.appendChild(weekdays);
            for (i = 0; i < 7; i++) {
                const weekday = document.createElement('p');
                weekday.setAttribute("class", "weekday");
                weekday.textContent = weekdays_all[i];
                weekdays.appendChild(weekday);
            }
        }


        function dayInitialize() {
            for (day = 1; day <= days_in_month[date.month]; day++) {

                ///// Create weeks /////

                // Calculate the weekday for current day
                const temp_date = new Date(months[date.month] + " " + day + ", " + date.year + " 12:00:00");
                let weekday = temp_date.getDay();

                // Start a new week if its the first of the month or a Monday
                if ((day === 1) || (weekday === 0)) {

                    // Create week div and add to calendar div
                    const week = document.createElement('div');
                    week.setAttribute("class", "week");
                    const calendar = document.getElementById('calendar');
                    calendar.appendChild(week);

                    // If it is the start of the month, add appropriate amount of empty days
                    if ((day === 1) && (weekday !== 0)) {
                        for (i = 0; i < weekday; i++) {
                            const nullday = document.createElement('div');
                            nullday.setAttribute("class", "nullday");
                            const currentWeek = document.querySelector('.week:last-child');
                            currentWeek.appendChild(nullday);
                        }
                    }
                }


                ///// Fill weeks with days /////
                // Start a div for each day
                const new_day = document.createElement('div');
                new_day.setAttribute("class", "day");
                new_day.setAttribute("id", "day" + day)

                // Add tag for the header space for the day's number
                const dayTitle = document.createElement('p');
                dayTitle.setAttribute("class", "dayTitle");
                new_day.appendChild(dayTitle);

                // Add tag for the number itself and add the day to it  
                const dayNum = document.createElement('span');
                dayNum.setAttribute("class", "dayNum");
                dayTitle.appendChild(dayNum);
                dayNum.innerHTML = (day) + '<br>';

                // Make a blue circle around the day number if it is the current day
                if ((day == today.getDate()) && (date.month == today.getMonth()) && (date.year == today.getFullYear())) {
                    dayNum.style.backgroundColor = '#6096B4';
                    dayNum.style.borderRadius = '10px';
                }



                // Add tag for events (unfilled for now)
                const dayEvents = document.createElement('div');
                dayEvents.setAttribute("class", "dayEvents");
                dayEvents.setAttribute("id", 'dayEvents' + (day));
                new_day.appendChild(dayEvents);


                // Add days to appropriate week
                const currentWeek = document.querySelector('.week:last-child');
                currentWeek.appendChild(new_day);


                ///// Finish last week with empty slots if necessary ///// 
                // The month is over. Add the rest of the null days to fill in the calendar
                if (day == days_in_month[date.month]) {
                    for (i = 0; i < 6 - weekday; i++) {
                        const nullday = document.createElement('div');
                        nullday.setAttribute("class", "nullday");
                        const currentWeek = document.querySelector('.week:last-child');
                        currentWeek.appendChild(nullday);
                    }
                }
            }
        }


        async function addUserFn() {

            // Get the all of the events for the current month
            const currentMonth = {
                'month': date.month,
                'year': date.year
            };
            let currentMonthEvents = await getMonthEvents(currentMonth);

            // Array for storing all events in the current ady
            const dayEvents = [];
console.log(currentMonthEvents.length);
let numEvents = Object.keys(currentMonthEvents).length - 1;
            // Iterate through each event in the month and display it properly
            for (let i = 0; i < numEvents; i++) {
console.log[i];

                // Retrieve the properties of each event
                let eventArray = currentMonthEvents[i].split(',');
                let day = eventArray[0];
                let title = eventArray[1];
                let time = eventArray[2];
                let id = eventArray[3];
                let color = eventArray[4];

                // Format the time 
                let timeArray = time.split(':');
                let amPM = 'AM';

                if (Number(timeArray[0]) >= 12) {
                    if (Number(timeArray[0]) >= 13) {
                        timeArray[0] = timeArray[0] - 12;
                    }
                    amPM = ' PM';
                }
                let timeSplit = timeArray[0] + ':' + timeArray[1] + ' ' + amPM;


                // The div that the event belongs in
                const dayLoc = document.getElementById('dayEvents' + day);

                // Make <p> for the event, add it to the day, set it to the proper color, and fill the innerHTML
                const event = document.createElement('p');
                event.setAttribute("class", "event");
                dayLoc.appendChild(event);
                event.style.backgroundColor = colors[color];
                event.innerHTML += title + ' ' + timeSplit + '<br>';

                // Add it to the dayEvents array if it takes place on the current day
                if (day == today.getDate()) {
                    dayEvents.push(eventArray);
                }

                // View an event
                event.addEventListener('click', function (event) {
                    event.stopPropagation();

                    // Close any possible open create window
                    closeCreateEvent();

                    // Calculate position for view window
                    let viewEventModal = document.getElementById('viewEventModal');
                    viewEventModal.style.display = "block";
                    let dayPos = dayLoc.getBoundingClientRect();
                    let centerX = dayPos.x + (dayPos.width / 2);

                    if (centerX < window.innerWidth / 2) { /// LEFT
                        let xPos = centerX + (dayPos.width / 2);
                        viewEventModal.style.left = (xPos + 2) + 'px';
                    } else {  // RIGHT
                        let xPos = centerX - (dayPos.width / 2) - viewEventModal.offsetWidth;
                        viewEventModal.style.left = (xPos - 2) + 'px';

                    }
                    viewEventModal.style.top = dayPos.top + 'px';

                    // If it is a birthday, show confetti
                    if (title.toLowerCase().includes('birthday')) {

                        let particles = document.querySelectorAll('.confettiParticle');
                        if (particles.length == 0) {
                            makeConfetti();
                        }
                    }


                    // Hide the edit window and show the body of the event
                    let viewHeaderTitle = document.getElementById('viewHeaderTitle');
                    let viewBody = document.getElementById('viewBody');
                    let viewEdit = document.getElementById('viewEdit');
                    viewEdit.style.display = 'none';
                    viewBody.style.display = 'block';

                    // Truncate title if its long and load it in
                    let splitTitle = title.substring(0, 22);
                    if (splitTitle != title) {
                        splitTitle += '...';
                    }
                    viewHeaderTitle.textContent = splitTitle;

                    // Format time
                    let unformattedTime = new Date('January 1, 1970 ' + time);
                    let formattedTime = (unformattedTime.toLocaleTimeString('en-US', { hour: "2-digit", minute: "2-digit" }));
                    let formattedTime24 = (unformattedTime.toLocaleTimeString('en-US', { hour12: false }));

                    // Load the body of the modal
                    viewBody.innerHTML = 'Event: ' + splitTitle + '<br>';
                    viewBody.innerHTML += 'Time: ' + formattedTime + '<br>';
                    viewBody.innerHTML += 'Color: ' + color;

                    // Load in preexisting values for each element
                    document.getElementById('editedTitle').value = '' + splitTitle + '';
                    document.getElementById('editedTime').value = formattedTime24;
                    document.getElementById('editedColor').value = color;
                    document.getElementById('editID').value = '' + id + '';

                    // Highlight exisiting color and make sure the rest are not highlgihted
                    document.getElementById('editColor' + color).style.border = '2px solid black';
                    for (let ii = 0; ii < colors.length; ii++) {
                        if (ii != color) {
                            document.getElementById('editColor' + ii).style.border = '';
                        }
                    }


                })

                ///

                function makeConfetti() {

                    let parentDiv = document.getElementById('confetti');

                    // Starting x and y positions of the confetti
                    let x = document.getElementById('viewEventModal').getBoundingClientRect().left - parentDiv.offsetLeft + viewEventModal.offsetWidth / 2;
                    let y = document.getElementById('viewEventModal').getBoundingClientRect().top - parentDiv.offsetTop;

                    // Make 25 pieces of confetti
                    for (let i = 0; i < 25; i++) {

                        // Make the body
                        const particle = document.createElement('p');
                        particle.setAttribute('class', 'confettiParticle');
                        parentDiv.appendChild(particle);

                        // Set the initial x and y positions and the x and y velocities, as well as a random number to establish if x velocity is positive or negative
                        particle.innerHTML = '<input type="hidden" id="x' + i + '" value ="' + x + '">';
                        particle.innerHTML += '<input type="hidden" id="xv' + i + '" value ="' + Math.random() + '">';

                        particle.innerHTML += '<input type="hidden" id="y' + i + '" value ="' + y + '">';
                        particle.innerHTML += '<input type="hidden" id="yv' + i + '" value ="' + Math.random() + '">';

                        particle.innerHTML += '<input type="hidden" id="posNeg' + i + '" value ="' + Math.random() + '">';


                        // Set each piece to a random color
                        let rand = Math.random();
                        if (rand > .8) {
                            particle.style.backgroundColor = 'green';
                        } else if (rand > .6) {
                            particle.style.backgroundColor = 'blue';
                        } else if (rand > .4) {
                            particle.style.backgroundColor = 'purple';
                        } else if (rand > .2) {
                            particle.style.backgroudnColor = 'yellow';
                        }

                    }

                    // Set the interval the confetti will move on
                    let startTime = Date.now();
                    let timer = setInterval(function () {
                        let inc = Date.now() - startTime;
                        if (inc > 1500) {
                            clearInterval(timer);
                            removeConfetti();
                            return;
                        }

                        confettiMotion(inc);
                    }, 50);


                    function confettiMotion(inc) {
                        let particles = document.querySelectorAll('.confettiParticle');
                        let index = 0;

                        // iterate through each piece of confetti
                        for (let particle of particles) {

                            //make sure they are visible and set the time
                            particle.style.display = 'inline';
                            const time = inc / 35;

                            // Establish parts of the parabolic equation
                            const xScalar = 5 + (document.getElementById('xv' + index).value * 2 - 0.5);
                            const xStart = parseFloat(document.getElementById('x' + index).value);

                            // Determine if x velocity is positive or negative and update its position
                            if (document.getElementById('posNeg' + index).value > 0.5) {
                                let currentX = xScalar * time + xStart + viewEventModal.offsetWidth / 2;

                                particle.style.left = currentX + 'px';
                            } else {
                                let currentX = (-1) * xScalar * time + xStart - viewEventModal.offsetWidth / 2;

                                particle.style.left = currentX + 'px';
                            }

                            // Calculate y's new position and update it
                            const yScalar = 5 + (document.getElementById('yv' + index).value * 2 - 0.5);
                            const yStart = parseFloat(document.getElementById('y' + index).value)
                            let currentY = yScalar * ((time ** 2) / 40) + yStart;
                            particle.style.top = currentY + 'px';

                            index++;
                            document.getElementById('confetti').style.display = 'inline';
                        }
                    }
                    // Iterate through each particle and delete the <p>, removing the confetti
                    function removeConfetti() {
                        let particles = document.querySelectorAll('.confettiParticle');
                        for (let particle of particles) {
                            particle.remove();
                        }
                    }
                }
            }
        }



        // Buttons within the view modal
        function viewButtons() {
            document.getElementById('closeViewBtn').addEventListener('click', closeViewModal, false);

            // Delete event
            document.getElementById('deleteEvent').addEventListener('click', function () {

                // Retrieve necessary info
                let eventID = document.getElementById('editID').value;
                const deleteData = {
                    'id': eventID,
                    'token': document.getElementById('token').value
                }

                // Delete and reload
                fetch("deleteEvent.php", {
                    method: 'POST',
                    body: JSON.stringify(deleteData),
                    headers: { 'content-type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(deleteData => {
                        const deleteDataJSON = JSON.parse(JSON.stringify(deleteData));
                        if (deleteDataJSON.status) {
                            reload();
                        } else {
                            alert(deleteDataJSON.error);
                        }

                    })
                    .catch(err => console.error(err));
            });

            // Toggle edit view
            document.getElementById('editViewBtn').addEventListener('click', function () {
                let viewBody = document.getElementById('viewBody');
                let viewEdit = document.getElementById('viewEdit');

                viewBody.style.display = 'none';
                viewEdit.style.display = 'block';
            });

            // Apply edit
            document.getElementById('applyEdit').addEventListener('click', function () {

                // Retrieve info and format it
                let newTitle = document.getElementById('editedTitle').value;
                let newTime = document.getElementById('editedTime').value;
                let newColor = document.getElementById('editedColor').value;
                let eventID = document.getElementById('editID').value;

                const editData = {
                    'title': newTitle,
                    'time': newTime,
                    'color': newColor,
                    'id': eventID,
                    'token': document.getElementById('token').value
                }

                // Execute edit and reload
                fetch("editEvent.php", {
                    method: 'POST',
                    body: JSON.stringify(editData),
                    headers: { 'content-type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(editData => {
                        const editDataJSON = JSON.parse(JSON.stringify(editData));
                        if (editDataJSON.status) {
                            reload();
                        } else {
                            alert(editDataJSON.error)
                        }
                    })
                    .catch(err => console.error(err));


            });


            // Add event listener for each color element
            let allColorsEdit = document.querySelectorAll('.colorEdit');

            for (let i = 0; i < allColorsEdit.length; i++) {
                allColorsEdit[i].addEventListener('click', function () {
                    event.stopPropagation();


                    // If click, highlight the clicked one and remove highlight from all others. Record value of clicked one.
                    for (let ii = 0; ii < allColorsEdit.length; ii++) {
                        allColorsEdit[ii].style.border = "";
                    }
                    allColorsEdit[i].style.border = "2px solid black";
                    document.getElementById('editedColor').value = i;

                })
            }

            // Same as above, but for new events instead of editing
            let allColorsCreate = document.querySelectorAll('.colorCreate');

            for (let i = 0; i < allColorsCreate.length; i++) {

                allColorsCreate[i].addEventListener('click', function () {

                    event.stopPropagation();


                    for (let ii = 0; ii < allColorsCreate.length; ii++) {
                        allColorsCreate[ii].style.border = "";
                    }

                    allColorsCreate[i].style.border = "2px solid black";
                    document.getElementById('createColor').value = i;

                })
            }
        }

        // Query PHP for all the current events and return them
        function getMonthEvents(currentMonth) {
            return fetch("events.php", {
                method: 'POST',
                body: JSON.stringify(currentMonth),
                headers: { 'content-type': 'application/json' }
            })
                .then(response => response.json())
                .then(currentMonth => {
                    const currentMonthJSON = JSON.parse(JSON.stringify(currentMonth));
                    if (currentMonthJSON.status) {
                        return currentMonthJSON;
                    } else {
                        alert(currentMonthJSON.error);
                    }

                })
                .catch(err => console.error(err));
        }

        // Add listener to each day to create events
        function addCreateEvents() {
            let all_days = document.querySelectorAll(".day");
            let currentIndex = null;

            // Listener for clicking create on the event modal
            document.getElementById('createEventBtn').addEventListener('click', function () {

                if ((currentIndex != null)) {


                    // Retrieve relevant info
                    const newEventData = {
                        'title': document.getElementById('newEventTitle').value,
                        'time': document.getElementById('newEventTime').value,
                        'day': currentIndex,
                        'month': date.month,
                        'year': date.year,
                        'color': document.getElementById('createColor').value,
                        'token': document.getElementById('token').value
                    };

                    // AJAX to PHP
                    fetch("newEvent.php", {
                        method: 'POST',
                        body: JSON.stringify(newEventData),
                        headers: { 'content-type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(newEventData => {
                            const newEventDataJSON = JSON.parse(JSON.stringify(newEventData));
                            if (newEventDataJSON.status) {
                                document.getElementById('createEventModal').style.display = 'none';
                                // Remove the New Event box from old boxes
                                let allNewEvents = document.querySelectorAll('.newEvent');
                                for (let i = 0; i < allNewEvents.length; i++) {
                                    allNewEvents[i].innerHTML = '';
                                    allNewEvents[i].style.display = 'none';
                                }

                                reload();
                            } else {
                                alert(newEventDataJSON.error);
                            }


                        })
                        .catch(err => console.error(err));


                    currentIndex = null;
                }
            })


            all_days.forEach((day, index) => {
                day.addEventListener('click', function () {
                    fetch("userCheck.php")
                        .then(user_check => user_check.json())
                        .then(user_check => {
                            const user_check_json = JSON.parse(JSON.stringify(user_check));
                            if (user_check_json.status) {
                                if (user_check_json.loggedIn) {
                                    const newEvent = document.createElement('p');
                                    newEvent.setAttribute("class", "newEvent");
                                    day.insertBefore(newEvent, day.lastChild);

                                    // reset the text boxes on the event modal
                                    let title = document.getElementById('newEventTitle');
                                    let time = document.getElementById('newEventTime');

                                    title.value = "";
                                    time.value = "";


                                    let allColorsCreate = document.querySelectorAll('.colorCreate');

                                    for (let ii = 0; ii < allColorsCreate.length; ii++) {
                                        allColorsCreate[ii].style.border = "";
                                    }

                                    // Remove the New Event box from old boxes
                                    let allNewEvents = document.querySelectorAll('.newEvent');
                                    for (let i = 0; i < allNewEvents.length; i++) {
                                        allNewEvents[i].innerHTML = '';
                                        allNewEvents[i].style.display = 'none';
                                    }

                                    // Get New Event box ready for current day 
                                    newEvent.innerHTML = 'New Entry <br>';
                                    newEvent.style.display = 'inline';

                                    // Close event viewer
                                    closeViewModal();

                                    let createEventModal = document.getElementById('createEventModal');
                                    createEventModal.style.display = "block";
                                    let dayPos = day.getBoundingClientRect();
                                    let centerX = dayPos.x + (dayPos.width / 2);

                                    if (centerX < window.innerWidth / 2) { /// LEFT
                                        let xPos = centerX + (dayPos.width / 2);
                                        createEventModal.style.left = (xPos + 2) + 'px';
                                    } else {  // RIGHT
                                        let xPos = centerX - (dayPos.width / 2) - createEventModal.offsetWidth;
                                        createEventModal.style.left = (xPos - 2) + 'px'
                                    }
                                    createEventModal.style.top = dayPos.top + 'px';
                                    currentIndex = index;
                                }
                            } else {
                                alert(user_check_json.error);
                            }
                        })
                        .catch(err => console.error(err));

                });
            })

        }


        function reload() {
            // Remove all events
            let eventsList = document.querySelectorAll('.dayEvents')

            for (let i = 0; i < eventsList.length; i++) {
                while (eventsList[i].hasChildNodes()) {
                    eventsList[i].removeChild(eventsList[i].firstChild);
                }
            }

            // Close modals
            closeCreateEvent();
            closeViewModal();

            // Load new events
            addUserFn();
        }


    </script>



</body>

</html>
